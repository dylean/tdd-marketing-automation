name: CI/CD Pipeline

on:
  push:
    branches: [ main ]  # åªåœ¨ main åˆ†æ”¯è§¦å‘

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write

jobs:
  # ===== CI é˜¶æ®µ =====
  build-and-test:
    name: ğŸ§ª æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: tdd_marketing_automation_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: ç¼–è¯‘é¡¹ç›®
        run: ./gradlew clean compileJava compileTestJava --no-daemon

      - name: è¿è¡Œå•å…ƒæµ‹è¯•å’Œæ¶æ„æµ‹è¯•
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.domain.*" --tests "com.tdd.ma.application.*" --tests "com.tdd.ma.architecture.*"
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.integration.*"
        env:
          SPRING_PROFILES_ACTIVE: test
          TEST_DB_URL: localhost
          TEST_DB_PORT: 3306
          TEST_DB_NAME: tdd_marketing_automation_test
          TEST_DB_USERNAME: root
          TEST_DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: æµ‹è¯•ç»“æœ
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/test/

      - name: æ„å»º JAR åŒ…
        run: ./gradlew bootJar --no-daemon

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar
          retention-days: 7

  code-quality:
    name: ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆCheckstyle + SpotBugsï¼‰
        run: ./gradlew check -x test --no-daemon
        continue-on-error: true

  # ===== CD é˜¶æ®µ =====
  deploy:
    name: ğŸš€ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]  # ä¾èµ– CI é˜¶æ®µ
    if: success()  # åªæœ‰ CI å…¨éƒ¨æˆåŠŸæ‰æ‰§è¡Œ

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: æ„å»ºåº”ç”¨
        run: ./gradlew bootJar --no-daemon

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:latest

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ Docker é•œåƒå·²æ¨é€åˆ° Docker Hub:"
          echo "   ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:${{ steps.version.outputs.version }}"
          echo "   ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:latest"
          echo ""
          echo "ğŸš€ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‹‰å–å¹¶è¿è¡Œ:"
          echo "   docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:latest"
          echo "   docker-compose up -d"

  # ===== æµæ°´çº¿çŠ¶æ€æ±‡æ€» =====
  pipeline-status:
    name: ğŸ“‹ æµæ°´çº¿çŠ¶æ€
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, deploy]
    if: always()

    steps:
      - name: æ£€æŸ¥æµæ°´çº¿çŠ¶æ€
        run: |
          echo "========================================"
          echo "         CI/CD æµæ°´çº¿æ‰§è¡Œç»“æœ"
          echo "========================================"
          echo "ğŸ§ª æ„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}"
          echo "ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
          echo "ğŸš€ Docker éƒ¨ç½²: ${{ needs.deploy.result }}"
          echo "========================================"
          
          if [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… æµæ°´çº¿å…¨éƒ¨æˆåŠŸï¼"
            exit 0
          else
            echo "âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
            exit 1
          fi
