name: CI/CD Pipeline

on:
  push:
    branches: [ main ]  # åªåœ¨ main åˆ†æ”¯è§¦å‘

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write

jobs:
  # ===== CI é˜¶æ®µ =====
  build-and-test:
    name: ğŸ§ª æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: tdd_marketing_automation_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: ç¼–è¯‘é¡¹ç›®
        run: ./gradlew clean compileJava compileTestJava --no-daemon

      - name: è¿è¡Œå•å…ƒæµ‹è¯•å’Œæ¶æ„æµ‹è¯•
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.domain.*" --tests "com.tdd.ma.application.*" --tests "com.tdd.ma.architecture.*"
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.integration.*"
        env:
          SPRING_PROFILES_ACTIVE: test
          TEST_DB_URL: localhost
          TEST_DB_PORT: 3306
          TEST_DB_NAME: tdd_marketing_automation_test
          TEST_DB_USERNAME: root
          TEST_DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: æµ‹è¯•ç»“æœ
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/test/

      - name: æ„å»º JAR åŒ…
        run: ./gradlew bootJar --no-daemon

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar
          retention-days: 7

  code-quality:
    name: ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆCheckstyle + SpotBugsï¼‰
        run: ./gradlew check -x test --no-daemon
        continue-on-error: true

  # ===== CD é˜¶æ®µ =====
  deploy-docker:
    name: ğŸ³ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]  # ä¾èµ– CI é˜¶æ®µ
    if: success()  # åªæœ‰ CI å…¨éƒ¨æˆåŠŸæ‰æ‰§è¡Œ

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradlew æ‰§è¡Œæƒé™
        run: chmod +x ./gradlew

      - name: æ„å»ºåº”ç”¨
        run: ./gradlew bootJar --no-daemon

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:latest

      - name: é•œåƒæ¨é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Docker é•œåƒå·²æ¨é€æˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾:"
          echo "   ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:${{ steps.version.outputs.version }}"
          echo "   ${{ secrets.DOCKER_HUB_USERNAME }}/tdd-marketing-automation:latest"

  deploy-sealos:
    name: â˜ï¸ éƒ¨ç½²åˆ° Sealos
    runs-on: ubuntu-latest
    needs: deploy-docker  # ä¾èµ– Docker é•œåƒæ¨é€æˆåŠŸ
    if: success()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: é…ç½® Sealos kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.SEALOS_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: æ›¿æ¢éƒ¨ç½²é…ç½®ä¸­çš„ç¯å¢ƒå˜é‡
        run: |
          # æ›¿æ¢ Docker Hub ç”¨æˆ·å
          sed -i "s/\${DOCKER_HUB_USERNAME}/${{ secrets.DOCKER_HUB_USERNAME }}/g" sealos/app-deployment.yaml
          
          # æ˜¾ç¤ºå°†è¦éƒ¨ç½²çš„é…ç½®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“‹ åº”ç”¨éƒ¨ç½²é…ç½®:"
          cat sealos/app-deployment.yaml | grep "image:"

      - name: æ£€æŸ¥ namespace æ˜¯å¦å­˜åœ¨
        run: |
          if kubectl get namespace tdd-ma > /dev/null 2>&1; then
            echo "âœ… Namespace tdd-ma å·²å­˜åœ¨"
          else
            echo "ğŸ“¦ åˆ›å»º namespace tdd-ma"
            kubectl create namespace tdd-ma
          fi

      - name: éƒ¨ç½²æ•°æ®åº“ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
        run: |
          # æ£€æŸ¥ MySQL Secret æ˜¯å¦å­˜åœ¨
          if kubectl get secret mysql-secret -n tdd-ma > /dev/null 2>&1; then
            echo "âœ… æ•°æ®åº“ Secret å·²å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®åº“éƒ¨ç½²"
          else
            echo "ğŸ“¦ é¦–æ¬¡éƒ¨ç½²ï¼Œåˆ›å»ºæ•°æ®åº“æœåŠ¡"
            # éœ€è¦å…ˆè®¾ç½®å¯†ç 
            kubectl create secret generic mysql-secret -n tdd-ma \
              --from-literal=username=root \
              --from-literal=password=${{ secrets.MYSQL_PASSWORD }} \
              --from-literal=root-password=${{ secrets.MYSQL_ROOT_PASSWORD }}
            
            kubectl create secret generic redis-secret -n tdd-ma \
              --from-literal=password=${{ secrets.REDIS_PASSWORD }}
            
            # éƒ¨ç½²æ•°æ®åº“
            kubectl apply -f sealos/database-deployment.yaml
            
            echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
            kubectl wait --for=condition=ready pod -l app=mysql -n tdd-ma --timeout=300s
            kubectl wait --for=condition=ready pod -l app=redis -n tdd-ma --timeout=300s
          fi

      - name: éƒ¨ç½²åº”ç”¨
        run: |
          echo "ğŸš€ éƒ¨ç½²åº”ç”¨åˆ° Sealos..."
          kubectl apply -f sealos/app-deployment.yaml
          
          echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          kubectl rollout status deployment/tdd-marketing-automation -n tdd-ma --timeout=300s

      - name: é‡å¯åº”ç”¨ï¼ˆæ‹‰å–æœ€æ–°é•œåƒï¼‰
        run: |
          echo "ğŸ”„ é‡å¯åº”ç”¨ä»¥æ‹‰å–æœ€æ–°é•œåƒ..."
          kubectl rollout restart deployment/tdd-marketing-automation -n tdd-ma
          kubectl rollout status deployment/tdd-marketing-automation -n tdd-ma --timeout=300s

      - name: è·å–éƒ¨ç½²çŠ¶æ€
        if: always()
        run: |
          echo "========================================"
          echo "         Sealos éƒ¨ç½²çŠ¶æ€"
          echo "========================================"
          echo ""
          echo "ğŸ“¦ Pods çŠ¶æ€:"
          kubectl get pods -n tdd-ma
          echo ""
          echo "ğŸŒ Services çŠ¶æ€:"
          kubectl get services -n tdd-ma
          echo ""
          echo "ğŸ”— Ingress çŠ¶æ€:"
          kubectl get ingress -n tdd-ma
          echo ""
          echo "ğŸ“Š HPA çŠ¶æ€:"
          kubectl get hpa -n tdd-ma

      - name: è·å–è®¿é—®åœ°å€
        if: success()
        run: |
          echo "========================================"
          echo "         ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "========================================"
          echo ""
          INGRESS_HOST=$(kubectl get ingress tdd-ma-ingress -n tdd-ma -o jsonpath='{.spec.rules[0].host}')
          echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: https://${INGRESS_HOST}"
          echo ""
          echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—:"
          echo "   kubectl logs -f deployment/tdd-marketing-automation -n tdd-ma"
          echo ""
          echo "ğŸ” æŸ¥çœ‹ Pod çŠ¶æ€:"
          echo "   kubectl get pods -n tdd-ma"

      - name: éƒ¨ç½²å¤±è´¥å›æ»š
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
          kubectl rollout undo deployment/tdd-marketing-automation -n tdd-ma || true
          
          echo "ğŸ“‹ æœ€è¿‘çš„ Pod æ—¥å¿—:"
          kubectl logs -l app=tdd-ma -n tdd-ma --tail=50 || true

  # ===== æµæ°´çº¿çŠ¶æ€æ±‡æ€» =====
  pipeline-status:
    name: ğŸ“‹ æµæ°´çº¿çŠ¶æ€
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, deploy-docker, deploy-sealos]
    if: always()

    steps:
      - name: æ£€æŸ¥æµæ°´çº¿çŠ¶æ€
        run: |
          echo "========================================"
          echo "         CI/CD æµæ°´çº¿æ‰§è¡Œç»“æœ"
          echo "========================================"
          echo "ğŸ§ª æ„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}"
          echo "ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
          echo "ğŸ³ Docker é•œåƒæ¨é€: ${{ needs.deploy-docker.result }}"
          echo "â˜ï¸  Sealos éƒ¨ç½²: ${{ needs.deploy-sealos.result }}"
          echo "========================================"
          
          if [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.deploy-docker.result }}" == "success" ] && \
             [ "${{ needs.deploy-sealos.result }}" == "success" ]; then
            echo "âœ… æµæ°´çº¿å…¨éƒ¨æˆåŠŸï¼"
            exit 0
          else
            echo "âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
            if [ "${{ needs.deploy-sealos.result }}" != "success" ]; then
              echo "âš ï¸  æ³¨æ„: Sealos éƒ¨ç½²å¤±è´¥ä¸å½±å“ Docker é•œåƒ"
            fi
            exit 1
          fi
