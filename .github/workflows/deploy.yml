name: Deploy

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    name: 部署到预发布环境
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: 构建应用
        run: ./gradlew bootJar --no-daemon

      - name: 构建 Docker 镜像
        run: |
          docker build -t tdd-marketing-automation:staging .

      - name: 推送到容器仓库
        run: |
          echo "推送镜像到容器仓库..."
          # docker push your-registry/tdd-marketing-automation:staging

      - name: 部署到 Staging
        run: |
          echo "部署到 Staging 环境..."
          # 这里添加你的部署脚本
          # 例如: kubectl apply -f k8s/staging/
          # 或者: ssh user@staging-server "cd /app && docker-compose up -d"

  deploy-production:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://app.example.com

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: 构建应用
        run: ./gradlew bootJar --no-daemon

      - name: 构建 Docker 镜像
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          docker build -t tdd-marketing-automation:$VERSION .
          docker tag tdd-marketing-automation:$VERSION tdd-marketing-automation:latest

      - name: 推送到容器仓库
        run: |
          echo "推送镜像到容器仓库..."
          # docker push your-registry/tdd-marketing-automation:$VERSION
          # docker push your-registry/tdd-marketing-automation:latest

      - name: 部署到 Production
        run: |
          echo "部署到 Production 环境..."
          # 添加生产环境部署脚本
          # 建议使用蓝绿部署或金丝雀发布

      - name: 健康检查
        run: |
          echo "执行健康检查..."
          # curl -f https://app.example.com/actuator/health || exit 1

      - name: 发布通知
        if: success()
        run: |
          echo "✅ 生产环境部署成功！版本: ${GITHUB_REF#refs/tags/}"
