name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: 构建和测试
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: tdd_marketing_automation_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: 授予 Gradlew 执行权限
        run: chmod +x ./gradlew

      - name: 编译项目
        run: ./gradlew compileJava compileTestJava --no-daemon

      - name: 运行单元测试和架构测试
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.domain.*" --tests "com.tdd.ma.application.*" --tests "com.tdd.ma.architecture.*"
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: 运行集成测试
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.integration.*"
        env:
          SPRING_PROFILES_ACTIVE: test
          TEST_DB_URL: localhost
          TEST_DB_PORT: 3306
          TEST_DB_NAME: tdd_marketing_automation_test
          TEST_DB_USERNAME: root
          TEST_DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: 生成测试报告
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: 测试结果
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: 上传测试报告
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/test/

      - name: 构建 JAR 包
        run: ./gradlew bootJar --no-daemon

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar
          retention-days: 7

  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: 运行架构守护测试
        run: ./gradlew test --no-daemon --tests "com.tdd.ma.architecture.*"

      - name: 检查代码风格
        run: ./gradlew check --no-daemon
        continue-on-error: true

  build-status:
    name: 构建状态通知
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: always()

    steps:
      - name: 检查构建状态
        run: |
          if [ "${{ needs.build-and-test.result }}" == "success" ] && [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "✅ 构建成功！"
            exit 0
          else
            echo "❌ 构建失败！"
            exit 1
          fi
